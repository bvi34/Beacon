@{
    ViewData["Title"] = "BDashboard";
    Layout = "_Layout";
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadMetrics();
            loadChartData();
            setupDiscoveryModal();
            loadRecentDevices();
            window.addDeviceModal = new AddDeviceModal();
        });

        async function loadMetrics() {
            const res = await fetch('/api/Discovery/status');
            const data = await res.json();
            document.querySelector('.metric-card.online .metric-number').textContent = data.onlineDevices;
            document.querySelector('.metric-card.offline .metric-number').textContent = data.offlineDevices;
            document.querySelector('.metric-card.warning .metric-number').textContent = data.recentlyAddedDevices;
            document.querySelector('.metric-card.total .metric-number').textContent = data.totalManagedDevices;
        }

        async function loadChartData() {
            // TODO: Hook this to real data
        }

        async function loadRecentDevices() {
            const res = await fetch('/Devices/api/devices');
            const data = await res.json();
            const container = document.getElementById('deviceListContainer');
            container.innerHTML = '';

            data.slice(0, 10).forEach(device => {
                const el = document.createElement('div');
                el.className = 'device-item';
                el.innerHTML = `<a href='/Devices/Details/${device.id}' class='device-link'><strong>${device.hostname}</strong> <span class='ip'>${device.ipAddress}</span></a>`;
                container.appendChild(el);
            });
        }

        function setupDiscoveryModal() {
            window.showDiscoveryModal = async function () {
                document.getElementById('discoveryModal').style.display = 'block';
                const spinner = document.getElementById('discoveryLoading');
                const results = document.getElementById('discoveryResults');
                const list = document.getElementById('discoveredDevicesList');
                spinner.style.display = 'block';
                results.style.display = 'none';

                const res = await fetch('/api/Discovery/scan-local', { method: 'POST' });
                const data = await res.json();

                spinner.style.display = 'none';
                results.style.display = 'block';
                list.innerHTML = '';
                data.newDevices.forEach(dev => {
                    const el = document.createElement('div');
                    el.className = 'discovered-device';
                    el.innerHTML = `<div><input type="checkbox" value="${dev.ipAddress}"> <strong>${dev.hostname || dev.ipAddress}</strong><br><small>${dev.ipAddress}</small></div>`;
                    list.appendChild(el);
                });
            };

            window.addSelectedDevices = async function () {
                const ips = Array.from(document.querySelectorAll('#discoveredDevicesList input:checked')).map(i => i.value);
                if (ips.length === 0) return alert('No devices selected.');
                await fetch('/api/Discovery/add-devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceIpAddresses: ips })
                });
                alert(`Added ${ips.length} device(s).`);
                location.reload();
            };

            window.closeDiscoveryModal = () => {
                document.getElementById('discoveryModal').style.display = 'none';
            };
        }
    </script>
}

<div class="container">
    <header class="header">
        <div class="logo-section">
            <div class="beacon-logo"><div class="beacon-icon"></div></div>
            <h1 class="gradient-text">Beacon Monitoring System</h1>
        </div>
        <div class="controls">
            <button class="btn btn-primary" onclick="addDeviceModal.show()">Add Device</button>
            <button class="btn btn-secondary" onclick="showDiscoveryModal()">🔍 Discover Devices</button>
            <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
        </div>
    </header>

    <section class="metrics-grid">
        <div class="metric-card online"><div class="metric-number">0</div><div class="metric-label">Devices Online</div></div>
        <div class="metric-card offline"><div class="metric-number">0</div><div class="metric-label">Devices Offline</div></div>
        <div class="metric-card warning"><div class="metric-number">0</div><div class="metric-label">Recently Added</div></div>
        <div class="metric-card total"><div class="metric-number">0</div><div class="metric-label">Total Devices</div></div>
    </section>

    <section class="chart-section">
        <div class="chart-card"><h3 class="chart-title">Device Status Over Time</h3><canvas id="statusChart"></canvas></div>
        <div class="chart-card"><h3 class="chart-title">Device Distribution</h3><canvas id="distributionChart"></canvas></div>
    </section>

    <section class="device-list">
        <h3 class="chart-title">Recent Device Activity</h3>
        <div id="deviceListContainer" class="device-list-container">Loading...</div>
    </section>
</div>

<div id="discoveryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Device Discovery</h2>
            <button class="close" onclick="closeDiscoveryModal()">&times;</button>
        </div>
        <div id="discoveryLoading" class="discovery-content">
            <div class="discovery-spinner"></div>
            <p>Scanning network for devices...</p>
        </div>
        <div id="discoveryResults" class="discovery-content" style="display:none;">
            <h3>Discovered Devices</h3>
            <div id="discoveredDevicesList" class="discovered-devices"></div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="addSelectedDevices()">Add Selected Devices</button>
                <button class="btn btn-secondary" onclick="showDiscoveryModal()">Scan Again</button>
            </div>
        </div>
    </div>
</div>
